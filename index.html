<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мини-приложение для рыбалки</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-image: url('/mnt/data/A_promotional_digital_illustration_for_"Russian_Fi.png');
            background-size: cover;
            background-position: center;
            color: #333;
            padding: 20px;
            height: 100vh;
            margin: 0;
        }

        .container {
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .button {
            background-color: #4CAF50;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            width: 100%;
        }

        .photo-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            width: 100%;
        }

        input, select {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            max-width: 300px;
        }

        label {
            font-size: 16px;
            margin-bottom: 5px;
        }

        #photoCountInfo {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }

        /* скрытый инпут для выбора фото (под капотом) */
        #hiddenFileInput { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Рыбалка на сегодня!</h1>

        <label for="category">Выберите категорию:</label>
        <select id="category">
            <option value="Фарм">Фарм</option>
            <option value="Трофей">Трофей</option>
            <option value="Уникальное">Уникальное</option>
        </select>

        <label for="lake">Выберите водоём:</label>
        <select id="lake" onchange="updateFishList(); updateButtonText();">
            <option value="Лосиное">Лосиное</option>
            <option value="Комариное">Комариное</option>
            <option value="Вьюнок">Вьюнок</option>
            <option value="Белая">Белая</option>
            <option value="Острог">Острог</option>
            <option value="Куори">Куори</option>
            <option value="Медвежье">Медвежье</option>
            <option value="Волхов">Волхов</option>
            <option value="Донец">Донец</option>
            <option value="Сура">Сура</option>
            <option value="Ладожское">Ладожское</option>
            <option value="Архипелаг">Архипелаг</option>
            <option value="Янтарное">Янтарное</option>
            <option value="Ахтуба">Ахтуба</option>
            <option value="Медное">Медное</option>
            <option value="Тунгуска">Тунгуска</option>
            <option value="Яма">Яма</option>
            <option value="Норвежское море">Норвежское море</option>
        </select>

        <label for="fish">Выберите рыбу:</label>
        <select id="fish"></select>

        <label for="coordinates">Координаты (например, 50.1234:30.5678):</label>
        <input type="text" id="coordinates">

        <label for="depth">Глубина:</label>
        <input type="text" id="depth">

        <label for="clips">Клипса:</label>
        <input type="text" id="clips">

        <label for="speed">Скорость:</label>
        <input type="text" id="speed">

        <label for="square">Квадрат:</label>
        <input type="text" id="square">

        <label for="comment">Комментарий:</label>
        <input type="text" id="comment">

        <button class="button" id="publishButton" onclick="sendDataToTelegram()">Отправить данные в Telegram</button>

        <button class="photo-button" id="addPhotoButton" onclick="openGallery()">Добавить фото (минимум 3, максимум 10)</button>

        <div id="photoCountInfo">Выбрано 0 фото. Минимум 3, максимум 10.</div>
    </div>

    <!-- невидимый input для выбора фото (мультивыбор) -->
    <input id="hiddenFileInput" type="file" accept="image/*" multiple />

    <script>
        // ===== НАСТРОЙКИ =====
        const WORKER_BASE = "https://rf-proxy.atvclub.workers.dev"; // твой воркер
        const GROUP_USERNAME = "PP4Farm"; // одна супергруппа с темами
        const MAX_PHOTOS = 10;
        const MIN_PHOTOS = 3;

        // Определяем Telegram Desktop (там вебвью требовательнее к POST)
        function isTelegramDesktop() {
          const ua = (navigator.userAgent || '').toLowerCase();
          return ua.includes('telegramdesktop') || ua.includes('tdesktop');
        }
        // Для desktop уменьшаем итоговый размер фото
        const MAX_PIXELS = isTelegramDesktop() ? 1280 : 2000;  // мобильный 2000px, desktop 1280px
        const JPEG_QUALITY = 0.85;

        // Водоём -> ссылка на тему (последний сегмент = message_thread_id)
        const groupByLake = {
            "Лосиное": "https://t.me/PP4Farm/4",
            "Комариное": "https://t.me/PP4Farm/3",
            "Вьюнок": "https://t.me/PP4Farm/5",
            "Белая": "https://t.me/PP4Farm/7",
            "Острог": "https://t.me/PP4Farm/6",
            "Куори": "https://t.me/PP4Farm/8",
            "Медвежье": "https://t.me/PP4Farm/9",
            "Волхов": "https://t.me/PP4Farm/10",
            "Донец": "https://t.me/PP4Farm/11",
            "Сура": "https://t.me/PP4Farm/12",
            "Ладожское": "https://t.me/PP4Farm/13",
            "Архипелаг": "https://t.me/PP4Farm/15",
            "Янтарное": "https://t.me/PP4Farm/14",
            "Ахтуба": "https://t.me/PP4Farm/16",
            "Медное": "https://t.me/PP4Farm/17",
            "Тунгуска": "https://t.me/PP4Farm/18",
            "Яма": "https://t.me/PP4Farm/19",
            "Норвежское море": "https://t.me/PP4Farm/20",
        };

        // ===== Справочник рыб (твой, без визуальных изменений) =====
        const fishByWater = {
            "Лосиное": [
                "Вармоус", "Горбыль речной", "Доросома северная", "Краппи белый", "Краппи чёрный",
                "Лаврак полосатый", "Лаврак полосатый гибрид", "Окунь белый", "Окунь большеротый",
                "Окунь малоротый", "Окунь павлиний", "Окунь пятнистый", "Панцирник пятнистый",
                "Солнечник красноухий", "Солнечник синежаберный", "Сомик канальный", "Сомик оливковый",
                "Судак светлопёрый", "Щука панцирная"
            ],
            "Комариное": [
                "Вьюн", "Голавль", "Густера", "Ёрш", "Карась золотой", "Карась серебряный",
                "Карп зеркальный", "Карп Кои Мидори-гои", "Карп чешуйчатый", "Лещ", "Линь",
                "Линь золотистый", "Лягушка", "Окунь", "Плотва обыкновенная", "Ротан", "Сом",
                "Уклейка", "Щука обыкновенная", "Язь"
            ],
            "Вьюнок": [
                "Разнорыбица", "Белоглазка", "Берш", "Голавль", "Густера", "Дрейссена речная",
                "Елец", "Ёрш", "Ёрш-носарь", "Жерех", "Карась золотой", "Карась серебряный",
                "Карп чешуйчатый", "Лещ", "Линь", "Лягушка", "Налим", "Окунь", "Перловица",
                "Пескарь обыкновенный", "Плотва обыкновенная", "Подуст", "Рак речной", "Ротан",
                "Синец", "Сом", "Судак", "Уклейка", "Щука обыкновенная", "Язь"
            ],
            "Белая": [
                "Разнорыбица", "Белоглазка", "Голавль", "Густера", "Елец", "Ёрш", "Жерех",
                "Карась золотой", "Карась серебрянный", "Карп чешуйчатый", "Лещ", "Лягушка",
                "Налим", "Окунь", "Перловица", "Пескарь обыкновенный", "Плотва обыкновенная",
                "Подуст", "Рак речной", "Сиг-пыжьян", "Сом", "Стерлядь", "Судак", "Таймень",
                "Уклейка", "Форель ручьевая", "Хариус европейский", "Хариус западносибирский",
                "Щука обыкновенная", "Язь"
            ],
            "Острог": [
                "Разнорыбица", "Амур белый", "Амур чёрный", "Голавль", "Густера", "Ёрш",
                "Карась золотой", "Карась серебряный", "Карп чешуйчатый", "Лещ", "Линь",
                "Лягушка", "Налим", "Окунь", "Плотва обыкновенная", "Ротан", "Сиг острожский",
                "Сом", "Угорь", "Уклейка", "Щука обыкновенная", "Язь"
            ],
            "Куори": [
                "Разнорыбица", "Голец арктический", "Голец Куорский", "Гольян", "Густера", "Ёрш",
                "Карась золотой", "Карась серебряный", "Карп чешуйчатый", "Лещ", "Лягушка",
                "Налим", "Окунь", "Палия обыкновенная", "Пелядь", "Плотва обыкновенная", "Ряпушка",
                "Сиг куорский", "Форель озёрная", "Форель радужная", "Форель ручьевая",
                "Форель севанская", "Хариус европейский", "Щука обыкновенная", "Язь"
            ],
            "Медвежье": [
                "Разнорыбица", "Амур белый", "Амур белый альбинос", "Амур чёрный", "Голавль",
                "Густера", "Ёрш", "Карась золотой", "Карась серебряный", "Карп голый",
                "Карп зеркальный", "Карп чешуйчатый", "Лещ", "Линь", "Линь золотистый",
                "Лягушка", "Налим", "Окунь", "Перловица", "Плотва обыкновенная", "Ротан",
                "Уклейка", "Усач альбинос", "Усач обыкновенный", "Щука обыкновенная", "Язь"
            ],
            "Волхов": [
                "Разнорыбица", "Белоглазка", "Голавль", "Густера", "Дрейссена речная", "Елец",
                "Ёрш", "Жерех", "Карась золотой", "Карась серебряный", "Карп чешуйчатый",
                "Лещ", "Линь", "Лосось атлантический", "лосось ладожский", "Лягушка", "Налим",
                "Окунь", "Перловица", "Пескарь обыкновенный", "Плотва обыкновенная", "Подуст",
                "Рак речной", "Ротан", "Рыбец", "Ряпушка", "Синец", "Сом", "Судак", "Угорь",
                "Уклейка", "Щука обыкновенная", "Язь"
            ],
            "Донец": [
                "Разнорыбица", "Амур белый", "Белоглазка", "Белуга черноморская", "Берш", "Вырезуб",
                "Голавль", "Густера", "Дрейссена речная", "Елец", "Ёрш", "Ёрш-носарь", "Жерех",
                "Карась золотой", "Карась серебряный", "Карп чешуйчатый", "Краснопёрка", "Лещ",
                "Линь", "Лягушка", "Минога Украинская", "Налим", "Окунь", "Окунь солнечный",
                "Осётр Русский", "Перловица", "Пескарь обыкновенный", "Плотва обыкновенная",
                "Подуст", "Рак речной", "Сазан", "Сельдь черноморская", "Уклейка", "Чехонь",
                "Шемая черноморская", "Щука обыкновенная", "Язь"
            ],
            "Сура": [
                "Разнорыбица", "Белоглазка", "Берш", "Голавль", "Густера", "Дрейссена речная",
                "Елец", "Ёрш", "Жерех", "Карась золотой", "Карась серебряный", "Карп чешуйчатый",
                "Краснопёрка", "Лещ", "Линь", "Лягушка", "Налим", "Окунь", "Осётр Русский",
                "Перловица", "Пескарь обыкновенный", "Плотва обыкновенная", "Подуст", "Рак речной",
                "Ротан", "Рыбец", "Сазан", "Синец", "Сом", "Стерлядь", "Судак", "Толстолобик белый",
                "толстолобик пёстрый", "Угорь", "Уклейка", "Чехонь", "Щука обыкновенная", "Язь"
            ],
            "Ладожское": [
                "Разнорыбица", "Белоглазка", "Голавль", "Гольян", "Густера", "Елец", "Ёрш",
                "Карась золотой", "Карась серебряный", "Карп чешуйчатый", "Колюшка трёхиглая",
                "Корюшка", "Лещ", "Лосось атлантический", "Лосось ладожский", "Лягушка",
                "Налим", "Окунь", "Осётр балтийский", "Палия обыкновенная", "Плотва обыкновенная",
                "Рипус", "Рыбец", "Ряпушка", "Сиг Валаамский", "Сиг Волховский", "Сиг Вуоксинский",
                "Сиг-Лудога", "Синец", "Сом", "Судак", "Угорь", "Уклейка", "Форель озёрная",
                "Хариус европейский", "Щука обыкновенная", "Язь"
            ],
            "Архипелаг": [
                "Разнорыбица", "Белоглазка", "Голавль", "Гольян", "Густера", "Елец", "Ёрш",
                "Карась золотой", "Карась серебряный", "Карп чешуйчатый", "Колюшка трёхиглая",
                "Корюшка", "Лещ", "Лосось атлантический", "Лосось ладожский", "Налим", "Окунь",
                "омуль Байкальский", "Осётр Балтийский", "Осётр Ладожский", "Палия кряжевая",
                "Палия лудожная", "Палия обыкновенная", "Рыбец", "Ряпушка", "Сиг Валаамский",
                "Сиг Волховский", "Сиг Вуоксинский", "Сиг Ладожский озёрный", "Сиг Свирский",
                "Сиг чёрный", "Сиг-Лудога", "Синец", "Сом", "Судак", "Угорь", "Уклейка", "Форель озёрная",
                "Хариус европейский", "Щука обыкновенная", "Язь"
            ],
            "Янтарное": [
                "Разнорыбица", "Амур белый", "Голавль", "Густера", "Ёрш", "Карась золотой",
                "Карась серебряный", "Карп голый", "Карп голый - альбинос", "Карп голый - призрак",
                "Карп зеркальный", "Карп зеркальный - альбинос", "Карп зеркальный - призрак",
                "Карп красный Старвас - зеркальный", "Карп красный Старвас - чешуйчатый", "Карп линейный",
                "Карп линейный - альбинос", "Карп линейный - призрак", "Карп рамчатый",
                "Карп рамчатый - альбинос", "Карп рамчатый - призрак", "Карп чешуйчатый",
                "Карп чешуйчатый - альбинос", "Карп чешуйчатый - призрак", "Лещ", "Линь", "Лягушка",
                "Налим", "Окунь", "Плотва обыкновенная", "Ротан", "Сом", "Угорь",
                "Усач обыкновенный", "Щука обыкновенная", "Язь"
            ],
            "Ахтуба": [
                "Разнорыбица", "Амур белый", "Белоглазка", "Белорыбица", "Белуга каспийская",
                "Буффало большеротый", "Буффало чёрный", "Вобла", "Вьюн", "Голавль", "Густера",
                "Дрейссена речная", "Елец", "Ёрш", "Жерех", "Карась золотой", "Карась серебряный",
                "Карп чешуйчатый", "Колюшка малая южная", "Краснопёрка", "Кутум", "Лещ", "Лещ восточный",
                "Линь", "Лосось каспийский", "Лягушка", "Минога каспийская", "Налим", "Окунь",
                "Осётр Персидский", "Осётр Русский", "Перловица", "Пескарь обыкновенный",
                "Плотва обыкновенная", "Подуст", "Пузанок каспийский", "Рак речной", "Сазан", "Севрюга",
                "Сельдь Бражникова", "Сельдь Кесслера", "Синец", "Сом", "Сом альбинос", "Стерлядь",
                "Судак", "Толстолобик белый", "Толстолобик пёстрый", "Уклейка", "Усач короткоголовый",
                "Чехонь", "Шемая каспийская", "Шип", "Щука обыкновенная", "Язь"
            ],
            "Медное": [
                "Разнорыбица", "Голавль", "Густера", "Ёрш", "Карасекарп", "Карась золотой",
                "Карась серебряный", "Карп голый", "Карп Динкенбюльский голый", "Карп Динкенбюльский зеркальный",
                "Карп Динкенбюльский линейный", "Карп зеркальный", "Карп Кои Ёцусиро", "Карп Кои Кохаку",
                "Карп Кои Мамэсибори Госики", "Карп Кои Хи Уцури", "Карп Супер Фрикс", "Карп чешуйчатый",
                "Лещ", "Линь", "Линь Квольсдорфский", "Лягушка", "Окунь", "Плотва обыкновенная", "ротан",
                "Уклейка", "Усач обыкновенный", "Щука обыкновенная", "Язь"
            ],
            "Тунгуска": [
                "Разнорыбица", "Валёк", "Голец арктический", "Голец Дерягина", "Голец сибирский-усач",
                "Гольян озёрный", "Горбуша", "Елец сибирский", "Ёрш", "Карась золотой", "Карась серебряный",
                "Колюшка трёхиглая", "Корюшка азиатская", "Ленок остроносый", "Лещ восточный", "Линь",
                "Лягушка", "Минога сибирская", "Муксун", "Налим", "Нельма", "Окунь", "Омуль арктический",
                "омуль Байкальский", "Осётр восточносибирский", "Пелядь", "Перловица", "пескарь сибирский",
                "Плотва сибирская", "Подкаменщик сибирский", "Ряпушка сибирская", "Сиг-пыжьян", "Сом амурский",
                "Стерлядь сибирская", "Таймень", "Тугун", "Форель ручьевая", "Хариус восточносибирский",
                "Хариус западносибирский", "Чир", "Щука обыкновенная", "Язь"
            ],
            "Яма": [
                "Разнорыбица", "Валёк", "Голец арктический", "Голец Леванидова", "Голец сибирский-усач",
                "Горбуша", "Калуга", "Кета", "Кижуч", "Колюшка девятииглая", "Корюшка азиатская",
                "Краснопёр Монгольский", "Краснопёр-Угай крупночешуйчатый", "Кунджа", "Ленок острорылый",
                "Ленок тупорылый", "Мальма", "Микижа", "Минога дальневосточная", "Минога трёхзубая", "Налим",
                "Нейва", "Нерка", "Окунь", "Сима", "Сима жилая", "Хариус восточносибирский", "Чавыча",
                "Чукучан"
            ],
            "Норвежское море": [
                "Разнорыбица", "Акула гигантская", "Акула гренладская полярная", "Акула плащеносная",
                "Акула сельдевая", "Бельдюга европейская", "Берикс красный", "Гимантолоф атлантический",
                "Горбыль серебристый", "Гребешок исландский", "Зубатка полостатая", "Зубатка пятнистая",
                "Зубатка синяя", "Кальмар обыкновенный", "Камбала морская", "Камбала палтусовидная",
                "Камбала хоботная", "Катран", "Керчак европейский", "Конгер", "Краб камчатский", "Краб съедобный",
                "Ликод полуолый", "Ликод Эсмарка", "Макрель атлантическая", "Макрурус северный", "Менёк",
                "Мерланг", "Мерлуза", "Меч-рыба", "Мидия", "Мольва голубая", "Мольва обыкновенная", "Морской чёрт",
                "Окунь каменный", "Окунь морской золотстый", "Окунь морской норвежский", "Окунь-клювач",
                "Опах краснопёрый", "палтус атлантический", "Палтус синекорый", "пикша", "Пинагор", "Поллак",
                "Путассу северная", "Сайда", "Сайра атлантическая", "Сардина европейская", "Сельдь атлантическая",
                "Скат колючий", "Скат полярный", "Треска атлантическая", "Тунец голубой", "Тюрбо",
                "Угольщик обыкновенный", "Устрица съедобная", "Химера европейская", "Центролоф чёрный"
            ]
        };

        // ===== Состояние =====
        let selectedPhotos = [];   // { imageUrl }
        let groupChatId = "";      // кешируем chat_id после первого запроса

        // ===== Визуал (как было) =====
        function updateFishList() {
            const lake = document.getElementById('lake').value;
            const fishList = fishByWater[lake] || [];
            const fishSelect = document.getElementById('fish');
            fishSelect.innerHTML = '';
            fishList.forEach(fish => {
                const option = document.createElement('option');
                option.value = fish;
                option.textContent = fish;
                fishSelect.appendChild(option);
            });
        }
        updateFishList();

        function updateButtonText() {
            const lake = document.getElementById('lake').value;
            const button = document.getElementById('publishButton');
            if (lake === "Лосиное") {
                button.textContent = "Опубликовать на Лосиное";
            } else {
                button.textContent = "Опубликовать данные";
            }
        }

        // ===== Подкапотная логика =====

        function openGallery() {
            if (selectedPhotos.length >= MAX_PHOTOS) {
                alert("Вы не можете выбрать больше 10 фото.");
                return;
            }
            document.getElementById('hiddenFileInput').click();
        }

        // JPEG -> Blob (без base64, стабильнее в Telegram webview)
        async function reencodeToJpegBlob(file) {
            if (file.size > 40 * 1024 * 1024) {
                throw new Error(`Слишком большой файл (${(file.size/1024/1024).toFixed(1)} MB).`);
            }
            const url = URL.createObjectURL(file);
            let bmp;
            try {
                const blob = await fetch(url).then(r => r.blob());
                bmp = await createImageBitmap(blob);
            } catch {
                throw new Error(`Не удалось прочитать файл. Если это HEIC/Live Photo — экспортируйте в JPEG/PNG.`);
            } finally {
                URL.revokeObjectURL(url);
            }
            const canvas = document.createElement('canvas');
            let { width, height } = bmp;
            const scale = Math.max(width, height) > MAX_PIXELS ? MAX_PIXELS / Math.max(width, height) : 1;
            width = Math.round(width * scale); height = Math.round(height * scale);
            canvas.width = width; canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(bmp, 0, 0, width, height);
            const blob = await new Promise(res => canvas.toBlob(res, 'image/jpeg', JPEG_QUALITY));
            if (!blob) throw new Error('Не удалось сконвертировать изображение');
            return blob;
        }

        // Загрузка на воркер (multipart/form-data), с учётом Desktop
        async function uploadToImgbbViaWorker(fileBlob, name){
            const form = new FormData();
            form.set('file', fileBlob, (name || 'photo') + '.jpg');
            form.set('name', name || 'photo');

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 30_000); // 30s safety

            const r = await fetch(`${WORKER_BASE}/upload`, {
                method: 'POST',
                body: form,
                keepalive: !isTelegramDesktop(), // на десктопе выключаем
                mode: 'cors',
                signal: controller.signal
            }).catch(e => {
                clearTimeout(timeout);
                throw new Error(`Сеть/вебвью: ${e?.message || e}`);
            });
            clearTimeout(timeout);

            let j;
            try { j = await r.json(); }
            catch (e) { throw new Error(`Ответ не JSON. HTTP ${r.status}.`); }

            if (!j.ok) {
                const reason = (j.error && typeof j.error === 'string') ? j.error : JSON.stringify(j.error||j);
                throw new Error(`imgbb: ${reason} (HTTP ${j.status||r.status||'?'})`);
            }
            return j.url;
        }

        // Обработчик выбора файлов (+ретраи и пауза для Desktop)
        document.getElementById('hiddenFileInput').addEventListener('change', async (e) => {
            const files = [...e.target.files || []];
            if (files.length === 0) return;

            const canTake = Math.min(MAX_PHOTOS - selectedPhotos.length, files.length);
            const slice = files.slice(0, canTake);

            for (let i = 0; i < slice.length; i++) {
                const file = slice[i];
                try {
                    const jpegBlob = await reencodeToJpegBlob(file);
                    let url, attempt = 0, lastErr = null;
                    while (attempt < 3) {
                        try {
                            url = await uploadToImgbbViaWorker(jpegBlob, file.name.replace(/\.[^.]+$/,''));
                            break;
                        } catch (err) {
                            lastErr = err;
                            attempt++;
                            console.log(`upload retry ${attempt}/3:`, err);
                            // на Desktop даём чуть больше паузу
                            if (isTelegramDesktop()) {
                              await new Promise(r => setTimeout(r, 400 + attempt * 200));
                            } else {
                              await new Promise(r => setTimeout(r, 200 + attempt * 150));
                            }
                        }
                    }
                    if (!url) throw lastErr || new Error('Не удалось загрузить на imgbb.');
                    selectedPhotos.push({ imageUrl: url });
                    console.log(`[upload ok] ${file.name} -> ${url}`);
                } catch (err) {
                    const offline = (navigator && navigator.onLine === false);
                    console.log(`[upload error] ${file.name}:`, err);
                    alert(`Не удалось обработать/загрузить файл: ${file.name}\n${offline ? 'Похоже, нет интернета.' : (err?.message || err)}`);
                }
            }
            updatePhotoCount();
            e.target.value = "";
        });

        function updatePhotoCount() {
            const photoCount = selectedPhotos.length;
            document.getElementById("photoCountInfo").textContent = `Выбрано ${photoCount} фото. Минимум ${MIN_PHOTOS}, максимум ${MAX_PHOTOS}.`;
        }

        // Получаем chat_id супергруппы по username
        async function ensureChatId() {
            if (groupChatId) return groupChatId;
            const r = await fetch(`${WORKER_BASE}/get_chat_id?username=${encodeURIComponent(GROUP_USERNAME)}`);
            const j = await r.json();
            if (!j.ok) throw new Error('Не удалось определить chat_id группы. Проверь, что бот добавлен в @PP4Farm.');
            groupChatId = String(j.chat_id);
            return groupChatId;
        }

        // Из ссылки извлекаем ID темы
        function getThreadIdByLake(lake) {
            const link = groupByLake[lake];
            if (!link) return null;
            const seg = (link.trim().split('/').pop() || '').replace(/\D+/g,'');
            const tid = parseInt(seg, 10);
            return Number.isFinite(tid) ? tid : null;
        }

        // Отправка в Telegram (альбом + текст) в тему
        async function sendToTelegram(chat_id, text, media, message_thread_id) {
            const r = await fetch(`${WORKER_BASE}/send`, {
                method: 'POST',
                headers: { 'content-type': 'application/json' },
                body: JSON.stringify({ chat_id, text, media, message_thread_id })
            });
            const j = await r.json();
            if (!j.ok) throw new Error('Telegram: ' + JSON.stringify(j.error || j));
            return j.result;
        }

        // Собираем текст поста (как у тебя)
        function buildText() {
            const category = document.getElementById('category').value;
            const lake = document.getElementById('lake').value;
            const fish = document.getElementById('fish').value;
            const coordinates = document.getElementById('coordinates').value;
            const depth = document.getElementById('depth').value;
            const clips = document.getElementById('clips').value;
            const speed = document.getElementById('speed').value;
            const square = document.getElementById('square').value;
            const comment = document.getElementById('comment').value;

            const data =
                `# ${category.toLowerCase()}_PP4Farm\n` +   // оставляю пробел после # как в твоём коде
                `# ${lake}_PP4Farm 💥\n` +
                `🐟 ${fish}\n` +
                `📍 Координаты: ${coordinates}\n` +
                `🎣 Клипса: ${clips}\n` +
                `⛅ Глубина: ${depth}\n` +
                `⚡ Скорость: ${speed}\n` +
                `🗺 Квадрат: ${square}\n` +
                `💬 Комментарий: ${comment}`;
            return data;
        }

        async function sendDataToTelegram() {
            try {
                if (selectedPhotos.length < MIN_PHOTOS) {
                    alert(`Необходимо выбрать минимум ${MIN_PHOTOS} фото.`);
                    return;
                }
                const lake = document.getElementById('lake').value;
                const threadId = getThreadIdByLake(lake);
                if (!threadId) {
                    alert("Не удалось определить тему для выбранного водоёма.");
                    return;
                }

                const chatId = await ensureChatId();
                const text = buildText();
                const mediaUrls = selectedPhotos.slice(0, MAX_PHOTOS).map(p => p.imageUrl);

                await sendToTelegram(chatId, text, mediaUrls, threadId);

                alert("Публикация отправлена!");
                console.log('[done] sent to thread', threadId, 'chat', chatId);
            } catch (e) {
                alert('Ошибка: ' + (e?.message || e));
            }
        }

        // Глобальные функции для onClick
        window.sendDataToTelegram = sendDataToTelegram;
        window.openGallery = openGallery;

        // Инициализация TWA
        if (window.Telegram?.WebApp) {
            Telegram.WebApp.init();
        }

        // Dev-лог в консоль (для разработки; пользователю не мешает)
        function logDev(...a){ try{ console.log('[miniapp]', ...a); }catch{} }
        logDev('loaded; desktop=', isTelegramDesktop());
    </script>
</body>
</html>
