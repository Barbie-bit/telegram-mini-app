<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Мини-приложение для рыбалки</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('/mnt/data/A_promotional_digital_illustration_for_"Russian_Fi.png');
      background-size: cover;
      background-position: center;
      color: #333;
      padding: 20px;
      height: 100vh;
      margin: 0;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      padding: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .button, .photo-button {
      color: white;
      padding: 15px 32px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
      width: 100%;
    }
    .button { background-color: #4CAF50; }
    .photo-button { background-color: #007bff; padding: 10px 20px; }
    input, select {
      margin: 10px 0;
      padding: 8px;
      width: 100%;
      max-width: 300px;
    }
    label { font-size: 16px; margin-bottom: 5px; display: block; }
    #photoCountInfo { margin-top: 10px; font-size: 14px; color: #666; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Рыбалка на сегодня!</h1>

    <label for="category">Выберите категорию:</label>
    <select id="category">
      <option value="Фарм">Фарм</option>
      <option value="Трофей">Трофей</option>
      <option value="Уникальное">Уникальное</option>
    </select>

    <label for="lake">Выберите водоём:</label>
    <select id="lake" onchange="updateFishList()">
      <option value="Лосиное">Лосиное</option>
      <option value="Комариное">Комариное</option>
      <option value="Вьюнок">Вьюнок</option>
      <option value="Белая">Белая</option>
      <option value="Острог">Острог</option>
      <option value="Куори">Куори</option>
      <option value="Медвежье">Медвежье</option>
      <option value="Волхов">Волхов</option>
      <option value="Донец">Донец</option>
      <option value="Сура">Сура</option>
      <option value="Ладожское">Ладожское</option>
      <option value="Архипелаг">Архипелаг</option>
      <option value="Янтарное">Янтарное</option>
      <option value="Ахтуба">Ахтуба</option>
      <option value="Медное">Медное</option>
      <option value="Тунгуска">Тунгуска</option>
      <option value="Яма">Яма</option>
      <option value="Норвежское море">Норвежское море</option>
    </select>

    <label for="fish">Выберите рыбу:</label>
    <select id="fish"></select>

    <label for="coordinates">Координаты:</label>
    <input type="text" id="coordinates" placeholder="например, 50.1234:30.5678">

    <label for="depth">Глубина:</label>
    <input type="text" id="depth" placeholder="например, 3.2">

    <label for="clips">Клипса:</label>
    <input type="text" id="clips" placeholder="например, 25">

    <label for="speed">Скорость:</label>
    <input type="text" id="speed" placeholder="например, 35">

    <label for="square">Квадрат:</label>
    <input type="text" id="square" placeholder="например, D6">

    <label for="comment">Комментарий:</label>
    <input type="text" id="comment" placeholder="доп. информация">

    <button class="button" onclick="sendData()">Опубликовать</button>
    <button class="photo-button" onclick="document.getElementById('hiddenFileInput').click()">Добавить фото (мин. 3, макс. 10)</button>

    <input type="file" id="hiddenFileInput" accept="image/*" multiple style="display:none">
    <div id="photoCountInfo">Выбрано 0 фото. Минимум 3, максимум 10.</div>
  </div>

  <script>
    // ===== настройки =====
    const WORKER_BASE = "https://rf-proxy.atvclub.workers.dev";
    const MAX_PHOTOS = 10;

    // chat_id твоей группы
    const CHAT_ID = -1002823326154;

    // темы (topic_id) по водоёмам
    const THREAD_BY_LAKE = {
      "Лосиное": 4,
      "Комариное": 3,
      "Вьюнок": 5,
      "Белая": 7,
      "Острог": 6,
      "Куори": 8,
      "Медвежье": 9,
      "Волхов": 10,
      "Донец": 11,
      "Сура": 12,
      "Ладожское": 13,
      "Архипелаг": 15,
      "Янтарное": 14,
      "Ахтуба": 16,
      "Медное": 17,
      "Тунгуска": 18,
      "Яма": 19,
      "Норвежское море": 20,
    };

    // кастом-эмодзи
    const CUSTOM_EMOJI_IDS = {
      TROPHY: "5341269699227321203",
      UNIQUE: "5341321204475133248",
    };

    // ===== массив рыб (как раньше, см. твой список) =====
    const fishByWater = { 
"Лосиное": ["Вармоус","Горбыль речной","Доросома северная","Краппи белый","Краппи чёрный","Лаврак полосатый","Лаврак полосатый гибрид","Окунь белый","Окунь большеротый","Окунь малоротый","Окунь павлиний","Окунь пятнистый","Панцирник пятнистый","Солнечник красноухий","Солнечник синежаберный","Сомик канальный","Сомик оливковый","Судак светлопёрый","Щука панцирная"],
      "Комариное": ["Вьюн","Голавль","Густера","Ёрш","Карась золотой","Карась серебряный","Карп зеркальный","Карп Кои Мидори-гои","Карп чешуйчатый","Лещ","Линь","Линь золотистый","Лягушка","Окунь","Плотва обыкновенная","Ротан","Сом","Уклейка","Щука обыкновенная","Язь"],
      "Вьюнок": ["Разнорыбица","Белоглазка","Берш","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Ёрш-носарь","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Лещ","Линь","Лягушка","Налим","Окунь","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Ротан","Синец","Сом","Судак","Уклейка","Щука обыкновенная","Язь"],
      "Белая": ["Разнорыбица","Белоглазка","Голавль","Густера","Елец","Ёрш","Жерех","Карась золотой","Карась серебрянный","Карп чешуйчатый","Лещ","Лягушка","Налим","Окунь","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Сиг-пыжьян","Сом","Стерлядь","Судак","Таймень","Уклейка","Форель ручьевая","Хариус европейский","Хариус западносибирский","Щука обыкновенная","Язь"],
      "Острог": ["Разнорыбица","Амур белый","Амур чёрный","Голавль","Густера","Ёрш","Карась золотой","Карась серебряный","Карп чешуйчатый","Лещ","Линь","Лягушка","Налим","Окунь","Плотва обыкновенная","Ротан","Сиг острожский","Сом","Угорь","Уклейка","Щука обыкновенная","Язь"],
      "Куори": ["Разнорыбица","Голец арктический","Голец Куорский","Гольян","Густера","Ёрш","Карась золотой","Карась серебряный","Карп чешуйчатый","Лещ","Лягушка","Налим","Окунь","Палия обыкновенная","Пелядь","Плотва обыкновенная","Ряпушка","Сиг куорский","Форель озёрная","Форель радужная","Форель ручьевая","Форель севанская","Хариус европейский","Щука обыкновенная","Язь"],
      "Медвежье": ["Разнорыбица","Амур белый","Амур белый альбинос","Амур чёрный","Голавль","Густера","Ёрш","Карась золотой","Карась серебряный","Карп голый","Карп зеркальный","Карп чешуйчатый","Лещ","Линь","Линь золотистый","Лягушка","Налим","Окунь","Перловица","Плотва обыкновенная","Ротан","Уклейка","Усач альбинос","Усач обыкновенный","Щука обыкновенная","Язь"],
      "Волхов": ["Разнорыбица","Белоглазка","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Лещ","Линь","Лосось атлантический","лосось ладожский","Лягушка","Налим","Окунь","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Ротан","Рыбец","Ряпушка","Синец","Сом","Судак","Угорь","Уклейка","Щука обыкновенная","Язь"],
      "Донец": ["Разнорыбица","Амур белый","Белоглазка","Белуга черноморская","Берш","Вырезуб","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Ёрш-носарь","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Краснопёрка","Лещ","Линь","Лягушка","Минога Украинская","Налим","Окунь","Окунь солнечный","Осётр Русский","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Сазан","Сельдь черноморская","Уклейка","Чехонь","Шемая черноморская","Щука обыкновенная","Язь"],
      "Сура": ["Разнорыбица","Белоглазка","Берш","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Краснопёрка","Лещ","Линь","Лягушка","Налим","Окунь","Осётр Русский","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Ротан","Рыбец","Сазан","Синец","Сом","Стерлядь","Судак","Толстолобик белый","толстолобик пёстрый","Угорь","Уклейка","Чехонь","Щука обыкновенная","Язь"],
      "Ладожское": ["Разнорыбица","Белоглазка","Голавль","Гольян","Густера","Елец","Ёрш","Карась золотой","Карась серебряный","Карп чешуйчатый","Колюшка трёхиглая","Корюшка","Лещ","Лосось атлантический","Лосось ладожский","Лягушка","Налим","Окунь","Осётр балтийский","Палия обыкновенная","Плотва обыкновенная","Рипус","Рыбец","Ряпушка","Сиг Валаамский","Сиг Волховский","Сиг Вуоксинский","Сиг-Лудога","Синец","Сом","Судак","Угорь","Уклейка","Форель озёрная","Хариус европейский","Щука обыкновенная","Язь"],
      "Архипелаг": ["Разнорыбица","Белоглазка","Голавль","Гольян","Густера","Елец","Ёрш","Карась золотой","Карась серебряный","Карп чешуйчатый","Колюшка трёхиглая","Корюшка","Лещ","Лосось атлантический","Лосось ладожский","Налим","Окунь","омуль Байкальский","Осётр Балтийский","Осётр Ладожский","Палия кряжевая","Палия лудожная","Палия обыкновенная","Рыбец","Ряпушка","Сиг Валаамский","Сиг Волховский","Сиг Вуоксинский","Сиг Ладожский озёрный","Сиг Свирский","Сиг чёрный","Сиг-Лудога","Синец","Сом","Судак","Угорь","Уклейка","Форель озёрная","Хариус европейский","Щука обыкновенная","Язь"],
      "Янтарное": ["Разнорыбица","Амур белый","Голавль","Густера","Ёрш","Карась золотой","Карась серебряный","Карп голый","Карп голый - альбинос","Карп голый - призрак","Карп зеркальный","Карп зеркальный - альбинос","Карп зеркальный - призрак","Карп красный Старвас - зеркальный","Карп красный Старвас - чешуйчатый","Карп линейный","Карп линейный - альбинос","Карп линейный - призрак","Карп рамчатый","Карп рамчатый - альбинос","Карп рамчатый - призрак","Карп чешуйчатый","Карп чешуйчатый - альбинос","Карп чешуйчатый - призрак","Лещ","Линь","Лягушка","Налим","Окунь","Плотва обыкновенная","Ротан","Сом","Угорь","Усач обыкновенный","Щука обыкновенная","Язь"],
      "Ахтуба": ["Разнорыбица","Амур белый","Белоглазка","Белорыбица","Белуга каспийская","Буффало большеротый","Буффало чёрный","Вобла","Вьюн","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Колюшка малая южная","Краснопёрка","Кутум","Лещ","Лещ восточный","Линь","Лосось каспийский","Лягушка","Минога каспийская","Налим","Окунь","Осётр Персидский","Осётр Русский","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Пузанок каспийский","Рак речной","Сазан","Севрюга","Сельдь Бражникова","Сельдь Кесслера","Синец","Сом","Сом альбинос","Стерлядь","Судак","Толстолобик белый","Толстолобик пёстрый","Уклейка","Усач короткоголовый","Чехонь","Шемая каспийская","Шип","Щука обыкновенная","Язь"],
      "Медное": ["Разнорыбица","Голавль","Густера","Ёрш","Карасекарп","Карась золотой","Карась серебряный","Карп голый","Карп Динкенбюльский голый","Карп Динкенбюльский зеркальный","Карп Динкенбюльский линейный","Карп зеркальный","Карп Кои Ёцусиро","Карп Кои Кохаку","Карп Кои Мамэсибори Госики","Карп Кои Хи Уцури","Карп Супер Фрикс","Карп чешуйчатый","Лещ","Линь","Линь Квольсдорфский","Лягушка","Окунь","Плотва обыкновенная","ротан","Уклейка","Усач обыкновенный","Щука обыкновенная","Язь"],
      "Тунгуска": ["Разнорыбица","Валёк","Голец арктический","Голец Дерягина","Голец сибирский-усач","Гольян озёрный","Горбуша","Елец сибирский","Ёрш","Карась золотой","Карась серебряный","Колюшка трёхиглая","Корюшка азиатская","Ленок остроносый","Лещ восточный","Линь","Лягушка","Минога сибирская","Муксун","Налим","Нельма","Окунь","Омуль арктический","омуль Байкальский","Осётр восточносибирский","Пелядь","Перловица","пескарь сибирский","Плотва сибирская","Подкаменщик сибирский","Ряпушка сибирская","Сиг-пыжьян","Сом амурский","Стерлядь сибирская","Таймень","Тугун","Форель ручьевая","Хариус восточносибирский","Хариус западносибирский","Чир","Щука обыкновенная","Язь"],
      "Яма": ["Разнорыбица","Валёк","Голец арктический","Голец Леванидова","Голец сибирский-усач","Горбуша","Калуга","Кета","Кижуч","Колюшка девятииглая","Корюшка азиатская","Краснопёр Монгольский","Краснопёр-Угай крупночешуйчатый","Кунджа","Ленок острорылый","Ленок тупорылый","Мальма","Микижа","Минога дальневосточная","Минога трёхзубая","Налим","Нейва","Нерка","Окунь","Сима","Сима жилая","Хариус восточносибирский","Чавыча","Чукучан"],
      "Норвежское море": ["Разнорыбица","Акула гигантская","Акула гренладская полярная","Акула плащеносная","Акула сельдевая","Бельдюга европейская","Берикс красный","Гимантолоф атлантический","Горбыль серебристый","Гребешок исландский","Зубатка полостатая","Зубатка пятнистая","Зубатка синяя","Кальмар обыкновенный","Камбала морская","Камбала палтусовидная","Камбала хоботная","Катран","Керчак европейский","Конгер","Краб камчатский","Краб съедобный","Ликод полуолый","Ликод Эсмарка","Макрель атлантическая","Макрурус северный","Менёк","Мерланг","Мерлуза","Меч-рыба","Мидия","Мольва голубая","Мольва обыкновенная","Морской чёрт","Окунь каменный","Окунь морской золотстый","Окунь морской норвежский","Окунь-клювач","Опах краснопёрый","палтус атлантический","Палтус синекорый","пикша","Пинагор","Поллак","Путассу северная","Сайда","Сайра атлантическая","Сардина европейская","Сельдь атлантическая","Скат колючий","Скат полярный","Треска атлантическая","Тунец голубой","Тюрбо","Угольщик обыкновенный","Устрица съедобная","Химера европейская","Центролоф чёрный"]
 };

    // ===== заполнение списка рыб =====
    function updateFishList() {
      const lake = document.getElementById('lake').value;
      const fishList = fishByWater[lake] || [];
      const fishSelect = document.getElementById('fish');
      fishSelect.innerHTML = '';
      if (fishList.length === 0) {
        const opt = document.createElement('option');
        opt.value = "";
        opt.textContent = "Не выбрано";
        fishSelect.appendChild(opt);
      } else {
        fishList.forEach(f => {
          const opt = document.createElement('option');
          opt.value = f;
          opt.textContent = f;
          fishSelect.appendChild(opt);
        });
      }
    }
    updateFishList();

    // ===== загрузка фото =====
    let selectedPhotos = [];
    function updatePhotoCount() {
      document.getElementById("photoCountInfo").textContent =
        `Выбрано ${selectedPhotos.length} фото. Минимум 3, максимум 10.`;
    }
    updatePhotoCount();

    async function blobToBase64(blob) {
      const buf = await blob.arrayBuffer();
      return btoa(String.fromCharCode(...new Uint8Array(buf)));
    }

    async function uploadToImgbbViaWorker(fileBlob, name) {
      const form = new FormData();
      form.set('file', fileBlob, (name || 'photo') + '.jpg');
      try {
        const r = await fetch(`${WORKER_BASE}/upload`, { method: 'POST', body: form, mode: 'cors' });
        const j = await r.json();
        if (j?.ok && j.url) return j.url;
        throw new Error('multipart fail');
      } catch {
        const b64 = await blobToBase64(fileBlob);
        const r2 = await fetch(`${WORKER_BASE}/upload`, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ imageBase64: b64, name: name || 'photo' }),
          mode: 'cors'
        });
        const j2 = await r2.json();
        if (j2?.ok && j2?.url) return j2.url;
        throw new Error('json fallback fail');
      }
    }

    document.getElementById('hiddenFileInput').addEventListener('change', async (e) => {
      const files = [...e.target.files || []];
      if (files.length === 0) return;
      const canTake = Math.min(MAX_PHOTOS - selectedPhotos.length, files.length);
      for (const file of files.slice(0, canTake)) {
        try {
          const url = await uploadToImgbbViaWorker(file, file.name.replace(/\.[^.]+$/, ''));
          selectedPhotos.push({ imageUrl: url });
        } catch {
          alert(`Не удалось загрузить файл: ${file.name}`);
        }
      }
      updatePhotoCount();
      e.target.value = "";
    });

    // ===== построение текста =====
    function buildTextAndEntities() {
      const category = document.getElementById('category').value;
      const lake = document.getElementById('lake').value;
      const fish = (document.getElementById('fish').value || "").trim();

      const coords = document.getElementById('coordinates').value.trim();
      const depth  = document.getElementById('depth').value.trim();
      const clips  = document.getElementById('clips').value.trim();
      const speed  = document.getElementById('speed').value.trim();
      const square = document.getElementById('square').value.trim();
      const comment= document.getElementById('comment').value.trim();

      const head = [`# ${category.toLowerCase()}_PP4Farm`, `# ${lake}_PP4Farm`, ''];
      let fishLine = "";
      const entities = [];

      if (fish) {
        fishLine = `🐟 ${fish}`;
        if (category === 'Трофей') fishLine += ' ◆';
        if (category === 'Уникальное') fishLine += ' ◆';
      }

      const details = [];
      if (coords) details.push(`📍 Координаты: ${coords}`);
      if (clips)  details.push(`🎣 Клипса: ${clips}`);
      if (depth)  details.push(`🎣 Глубина: ${depth}`);
      if (speed)  details.push(`⋙ Скорость: ${speed}`);
      if (square) details.push(`🗺 Квадрат: ${square}`);
      if (comment)details.push(`💬 Комментарий: ${comment}`);

      let text = [...head, fishLine, ...details].filter(Boolean).join('\n');
      if (fishLine.includes('◆')) {
        const idx = text.indexOf('◆');
        entities.push({
          type: 'custom_emoji',
          offset: idx,
          length: 1,
          custom_emoji_id: category === 'Трофей' ? CUSTOM_EMOJI_IDS.TROPHY : CUSTOM_EMOJI_IDS.UNIQUE
        });
        text = text.replace('◆',''); // убираем маркер, на его месте отрисуется emoji
      }
      return { text, entities: entities.length ? entities : undefined };
    }

    // ===== отправка =====
    async function sendData() {
      if (selectedPhotos.length < 3) {
        alert("Необходимо выбрать минимум 3 фото.");
        return;
      }
      const { text, entities } = buildTextAndEntities();
      const lake = document.getElementById('lake').value;
      const payload = {
        chat_id: CHAT_ID,
        text,
        media: selectedPhotos.map(p => p.imageUrl),
        entities,
        message_thread_id: THREAD_BY_LAKE[lake] ?? null
      };
      const r = await fetch(`${WORKER_BASE}/send`, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const j = await r.json();
      if (!j?.ok) { alert("Ошибка публикации"); return; }
      alert("Опубликовано!");
      document.querySelectorAll('input').forEach(el => el.value = "");
      selectedPhotos = [];
      updatePhotoCount();
    }
  </script>
</body>
</html>
