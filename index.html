<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Russian Fishing ‚Äî –ø—É–±–ª–∏–∫–∞—Ü–∏—è –ø–æ —Ç–µ–º–∞–º</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --border:#1f2a44; --ink:#e6e8ec; --muted:#9aa7c7; --accent:#2a6df5; --input:#0e1627; }
    *{box-sizing:border-box} body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--ink)}
    .wrap{max-width:820px;margin:0 auto;padding:20px} .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
    h1{font-size:20px;margin:12px 0 16px} label{font-size:14px;opacity:.95}
    textarea{width:100%;min-height:120px;border-radius:12px;border:1px solid var(--border);background:var(--input);color:var(--ink);padding:10px}
    input[type=file]{width:100%;margin-top:8px} .btn{display:inline-flex;align-items:center;gap:8px;background:var(--accent);border:none;border-radius:12px;color:#fff;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.55;cursor:not-allowed} .thumbs{display:grid;grid-template-columns:repeat(auto-fill,88px);gap:8px;margin-top:8px}
    .thumbs img{width:88px;height:88px;object-fit:cover;border-radius:10px;border:1px solid var(--border)} .pill{display:inline-block;padding:6px 8px;border-radius:999px;border:1px solid var(--border);margin:6px 6px 0 0;background:#0b1324;color:var(--muted)}
    .log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px;white-space:pre-wrap;background:var(--input);padding:10px;border-radius:10px;border:1px solid var(--border);max-height:260px;overflow:auto}
    .hint{font-size:12px;color:var(--muted);margin-top:6px} .groups{display:grid;gap:6px;margin-top:8px} .group-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
<div class="wrap">
  <h1>–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞ –∏ —Ñ–æ—Ç–æ –ø–æ —Ç–µ–º–∞–º</h1>

  <div class="card">
    <div class="group-row">
      <div>
        <label>–Æ–∑–µ—Ä–Ω–µ–π–º –≥—Ä—É–ø–ø—ã:</label><br>
        <input id="username" value="PP4Farm" style="width:220px;border-radius:10px;border:1px solid var(--border);padding:6px;background:var(--input);color:var(--ink)">
      </div>
      <div>
        <label>chat_id –≥—Ä—É–ø–ø—ã:</label><br>
        <input id="chatId" placeholder="-100..." style="width:220px;border-radius:10px;border:1px solid var(--border);padding:6px;background:var(--input);color:var(--ink)">
      </div>
      <button class="btn" id="resolveIdBtn">üîé –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å chat_id –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</button>
    </div>
    <div class="hint">–í–≤–µ–¥–∏ <b>@username</b> –∏ –Ω–∞–∂–º–∏ ¬´–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å chat_id¬ª, –ª–∏–±–æ —É–∫–∞–∂–∏ <code>-100‚Ä¶</code> –≤—Ä—É—á–Ω—É—é. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –≥—Ä—É–ø–ø–µ.</div>
  </div>

  <div class="card">
    <label for="text">–¢–µ–∫—Å—Ç –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
    <textarea id="text" placeholder="–û–ø–∏—à–∏—Ç–µ —É–ª–æ–≤, —Å–Ω–∞—Å—Ç–∏, –º–µ—Å—Ç–æ –∏ —Ç. –ø."></textarea>
  </div>

  <div class="card">
    <label for="files">–§–æ—Ç–æ (–¥–æ 10 —à—Ç) ‚Äî –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ JPEG, –º–∞–∫—Å 2000px</label>
    <input id="files" type="file" accept="image/*" multiple />
    <div class="thumbs" id="thumbs"></div>
    <div id="count" class="pill">0 / 10</div>
    <div class="hint">–ï—Å–ª–∏ –∏—Å—Ö–æ–¥–Ω–∏–∫ HEIC/Live Photo ‚Äî –º—ã –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ JPEG –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.</div>
  </div>

  <div class="card">
    <label>–¢–µ–º—ã</label>
    <div class="groups" id="topics"></div>
    <div class="hint">–ü–æ—Å—Ç —É–π–¥—ë—Ç –≤ –∫–∞–∂–¥—É—é –≤—ã–±—Ä–∞–Ω–Ω—É—é —Ç–µ–º—É (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏ –∞–ª—å–±–æ–º).</div>
  </div>

  <div class="card">
    <div class="row">
      <button class="btn" id="sendBtn">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      <button class="btn" id="clearBtn" style="background:#263553">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
  </div>

  <div class="card"><div class="log" id="log"></div></div>
</div>

<script>
const WORKER_BASE = "https://rf-proxy.atvclub.workers.dev";
const MAX_PHOTOS = 10;
const MAX_PIXELS = 2000; // –¥–ª–∏–Ω–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞
const JPEG_QUALITY = 0.85;

// –¢–≤–æ–∏ —Ç–µ–º—ã: name -> link (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–µ–≥–º–µ–Ω—Ç = ID —Ç–µ–º—ã)
const TOPIC_LINKS = {
  "–õ–æ—Å–∏–Ω–æ–µ": "https://t.me/PP4Farm/4",
  "–ö–æ–º–∞—Ä–∏–Ω–æ–µ": "https://t.me/PP4Farm/3",
  "–í—å—é–Ω–æ–∫": "https://t.me/PP4Farm/5",
  "–ë–µ–ª–∞—è": "https://t.me/PP4Farm/7",
  "–û—Å—Ç—Ä–æ–≥": "https://t.me/PP4Farm/6",
  "–ö—É–æ—Ä–∏": "https://t.me/PP4Farm/8",
  "–ú–µ–¥–≤–µ–∂—å–µ": "https://t.me/PP4Farm/9",
  "–í–æ–ª—Ö–æ–≤": "https://t.me/PP4Farm/10",
  "–î–æ–Ω–µ—Ü": "https://t.me/PP4Farm/11",
  "–°—É—Ä–∞": "https://t.me/PP4Farm/12",
  "–õ–∞–¥–æ–∂—Å–∫–æ–µ": "https://t.me/PP4Farm/13",
  "–ê—Ä—Ö–∏–ø–µ–ª–∞–≥": "https://t.me/PP4Farm/15",
  "–Ø–Ω—Ç–∞—Ä–Ω–æ–µ": "https://t.me/PP4Farm/14",
  "–ê—Ö—Ç—É–±–∞": "https://t.me/PP4Farm/16",
  "–ú–µ–¥–Ω–æ–µ": "https://t.me/PP4Farm/17",
  "–¢—É–Ω–≥—É—Å–∫–∞": "https://t.me/PP4Farm/18",
  "–Ø–º–∞": "https://t.me/PP4Farm/19",
  "–ù–æ—Ä–≤–µ–∂—Å–∫–æ–µ –º–æ—Ä–µ": "https://t.me/PP4Farm/20"
};

// DOM
const elText = document.getElementById('text');
const elFiles = document.getElementById('files');
const elThumbs = document.getElementById('thumbs');
const elCount = document.getElementById('count');
const elSend = document.getElementById('sendBtn');
const elClear = document.getElementById('clearBtn');
const elLog = document.getElementById('log');
const elTopics = document.getElementById('topics');
const elUsername = document.getElementById('username');
const elChatId = document.getElementById('chatId');
const elResolve = document.getElementById('resolveIdBtn');

function log(line){ elLog.textContent += `[${new Date().toLocaleTimeString()}] ${line}\n`; elLog.scrollTop = elLog.scrollHeight; }
function alertT(msg){ if(window.Telegram?.WebApp) Telegram.WebApp.showAlert(msg); else alert(msg); }

function buildTopics(){
  elTopics.innerHTML = '';
  Object.entries(TOPIC_LINKS).forEach(([name, link])=>{
    const tid = parseInt((link.trim().split('/').pop()||'').replace(/\D+/g,''),10);
    const idStr = Number.isFinite(tid) ? String(tid) : '';
    const row = document.createElement('label');
    row.innerHTML = `<input type="checkbox" class="topic" value="${idStr}"> ${name} <span class="pill">${idStr||'?'}</span>`;
    elTopics.appendChild(row);
  });
}
buildTopics();

// preview
elFiles.addEventListener('change', ()=>{
  elThumbs.innerHTML='';
  const files = [...elFiles.files].slice(0, MAX_PHOTOS);
  files.forEach(f=>{ const img=document.createElement('img'); img.src=URL.createObjectURL(f); img.alt=f.name; elThumbs.appendChild(img); });
  elCount.textContent = `${files.length} / ${MAX_PHOTOS}`;
  if (elFiles.files.length>MAX_PHOTOS) log(`–í—ã–±—Ä–∞–Ω–æ ${elFiles.files.length}, –ª–∏—à–Ω–∏–µ –±—É–¥—É—Ç –ø—Ä–æ–∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã.`);
});

// –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ JPEG + —Ä–µ—Å–∞–π–∑ –¥–æ 2000px
async function reencodeToJpeg(file){
  // –±—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Å–∞ ‚Äî –ø–æ–¥—Å–∫–∞–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
  if (file.size > 40 * 1024 * 1024) { // 40MB ‚Äî –≤—ã—à–µ –ª–∏–º–∏—Ç–∞ imgbb ~32MB
    throw new Error(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (${(file.size/1024/1024).toFixed(1)}MB). –£–º–µ–Ω—å—à–∏—Ç–µ —Ñ–æ—Ç–æ.`);
  }

  const url = URL.createObjectURL(file);
  let bmp;
  try {
    bmp = await createImageBitmap(await fetch(url).then(r=>r.blob()));
  } catch {
    // –ï—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –Ω–µ —É–º–µ–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä HEIC) ‚Äî –¥–∞–¥–∏–º –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É
    throw new Error(`–ë—Ä–∞—É–∑–µ—Ä –Ω–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª ${file.name}. –ï—Å–ª–∏ —ç—Ç–æ HEIC/Live Photo ‚Äî –æ—Ç–∫—Ä–æ–π—Ç–µ –≥–∞–ª–µ—Ä–µ—é –∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –∫–∞–∫ JPEG/PNG.`);
  } finally {
    URL.revokeObjectURL(url);
  }

  const canvas = document.createElement('canvas');
  let { width, height } = bmp;
  const scale = Math.max(width, height) > MAX_PIXELS ? MAX_PIXELS / Math.max(width, height) : 1;
  width = Math.round(width * scale);
  height = Math.round(height * scale);
  canvas.width = width; canvas.height = height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(bmp, 0, 0, width, height);
  const dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
  return dataUrl.split(',')[1]; // —á–∏—Å—Ç—ã–π base64
}

async function uploadToImgbb(base64, name){
  const r = await fetch(`${WORKER_BASE}/upload`, {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({ imageBase64: base64, name })
  });
  const j = await r.json();
  if (!j.ok) {
    const reason = (j.error && typeof j.error === 'string') ? j.error : JSON.stringify(j.error||j);
    throw new Error(`imgbb: ${reason} (status ${j.status||'?'})`);
  }
  return j.url;
}

async function sendToTelegram(chat_id, text, mediaUrls, message_thread_id){
  const r = await fetch(`${WORKER_BASE}/send`, {
    method:'POST', headers:{'content-type':'application/json'},
    body: JSON.stringify({ chat_id, text, media: mediaUrls, message_thread_id })
  });
  const j = await r.json();
  if (!j.ok) throw new Error('telegram: '+JSON.stringify(j.error||j));
  return j.result;
}

async function resolveChatId(username){
  const r = await fetch(`${WORKER_BASE}/get_chat_id?username=${encodeURIComponent(username)}`);
  const j = await r.json();
  if (!j.ok) throw new Error('resolve chat_id: '+JSON.stringify(j.error||j));
  return j.chat_id;
}

elResolve.addEventListener('click', async ()=>{
  try{
    elResolve.disabled=true;
    const uname = elUsername.value.trim().replace(/^@/,'');
    if(!uname) return alertT('–í–≤–µ–¥–∏—Ç–µ @username –≥—Ä—É–ø–ø—ã.');
    log(`–û–ø—Ä–µ–¥–µ–ª—è—é chat_id –ø–æ @${uname}‚Ä¶`);
    const cid = await resolveChatId(uname);
    elChatId.value = String(cid);
    log(`‚úì –ù–∞–π–¥–µ–Ω chat_id: ${cid}`);
    alertT('chat_id –∑–∞–ø–æ–ª–Ω–µ–Ω.');
  }catch(e){ console.error(e); alertT('–û—à–∏–±–∫–∞: '+(e?.message||e)); log('–û–®–ò–ë–ö–ê: '+(e?.message||e)); }
  finally{ elResolve.disabled=false; }
});

elSend.addEventListener('click', async ()=>{
  try{
    elSend.disabled = true;

    const chat_id = elChatId.value.trim();
    if (!chat_id) { alertT('–£–∫–∞–∂–∏—Ç–µ chat_id –≥—Ä—É–ø–ø—ã.'); return; }

    const text = elText.value.trim();
    const files = [...elFiles.files].slice(0, MAX_PHOTOS);
    const topics = [...document.querySelectorAll('.topic:checked')].map(x=>parseInt(x.value,10)).filter(Number.isFinite);

    if (!text && files.length===0) { alertT('–î–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ —Ñ–æ—Ç–æ.'); return; }
    if (topics.length===0) { alertT('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Ç–µ–º—É.'); return; }

    log(`–°—Ç–∞—Ä—Ç: —Ñ–∞–π–ª–æ–≤ ${files.length}, —Ç–µ–º ${topics.length}, chat_id ${chat_id}`);

    const urls=[];
    for(let i=0;i<files.length;i++){
      const f=files[i];
      try {
        log(`–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ ${i+1}/${files.length}: ${f.name}`);
        const b64 = await reencodeToJpeg(f);
        // —Ä–µ—Ç—Ä–∞–∏ –Ω–∞ –∏–º–≥–±–±
        let url, attempt=0, lastErr=null;
        while(attempt<3){
          try { url = await uploadToImgbb(b64, f.name.replace(/\.[^.]+$/,'')); break; }
          catch(err){ lastErr = err; attempt++; log(`imgbb retry ${attempt}/3 –¥–ª—è ${f.name}: ${err.message||err}`); await new Promise(r=>setTimeout(r, 800*attempt)); }
        }
        if(!url) throw lastErr || new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ imgbb.');
        urls.push(url);
        log(`‚úì URL: ${url}`);
      } catch (e) {
        log(`–û–®–ò–ë–ö–ê —Ñ–∞–π–ª–∞ ${f.name}: ${e?.message||e}`);
        alertT(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å/–∑–∞–≥—Ä—É–∑–∏—Ç—å "${f.name}": ${e?.message||e}`);
        return; // –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø—Ä–∞–≤–∏–ª
      }
    }

    for(const tid of topics){
      log(`–û—Ç–ø—Ä–∞–≤–∫–∞ –≤ —Ç–µ–º—É #${tid}‚Ä¶`);
      await sendToTelegram(chat_id, text, urls, tid);
      log(`‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Ç–µ–º—É #${tid}`);
    }

    alertT('–ü—É–±–ª–∏–∫–∞—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ç–µ–º–∞–º!');
    log('–ì–æ—Ç–æ–≤–æ ‚úî');
  }catch(e){ console.error(e); alertT('–û—à–∏–±–∫–∞: '+(e?.message||e)); log('–û–®–ò–ë–ö–ê: '+(e?.message||e)); }
  finally{ elSend.disabled=false; }
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  elText.value=""; elFiles.value=""; elThumbs.innerHTML=""; elCount.textContent=`0 / ${MAX_PHOTOS}`;
  elLog.textContent=""; [...document.querySelectorAll('.topic')].forEach(cb=>cb.checked=false);
});

(function initTWA(){ if(window.Telegram?.WebApp){ Telegram.WebApp.expand(); Telegram.WebApp.ready(); } })();
</script>
</body>
</html>
