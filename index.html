<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Russian Fishing — публикация в группы</title>
  <style>
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:0; background:#0b1220; color:#e6e8ec; }
    .wrap { max-width: 780px; margin: 0 auto; padding: 20px; }
    h1 { font-size: 20px; margin: 12px 0 16px; }
    .card { background:#121a2b; border:1px solid #1f2a44; border-radius:16px; padding:16px; margin-bottom:16px; }
    label { font-size:14px; opacity:.9; }
    textarea { width:100%; min-height:120px; border-radius:12px; border:1px solid #213255; background:#0e1627; color:#e6e8ec; padding:10px; }
    input[type=file] { width:100%; margin-top:8px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .btn { display:inline-block; background:#2a6df5; border:none; border-radius:12px; color:#fff; padding:12px 16px; font-weight:700; cursor:pointer; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    .thumbs { display:grid; grid-template-columns:repeat(auto-fill,88px); gap:8px; margin-top:8px; }
    .thumbs img { width:88px; height:88px; object-fit:cover; border-radius:10px; border:1px solid #1f2a44; }
    .log { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; white-space:pre-wrap; background:#0e1627; padding:10px; border-radius:10px; border:1px solid #1f2a44; max-height:220px; overflow:auto; }
    .pill { display:inline-block; padding:6px 8px; border-radius:999px; border:1px solid #1f2a44; margin:2px 6px 2px 0; background:#0b1324; }
    .groups { display:grid; gap:6px; margin-top:8px; }
    .groups label { display:inline-flex; gap:8px; align-items:center; }
  </style>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Публикация отчёта и фото</h1>

    <div class="card">
      <label>Текст публикации</label>
      <textarea id="text" placeholder="Опишите улов, снасти, место и т. п."></textarea>
    </div>

    <div class="card">
      <label>Фото (до 10 шт)</label>
      <input id="files" type="file" accept="image/*" multiple />
      <div class="thumbs" id="thumbs"></div>
      <div id="count" class="pill">0 / 10</div>
    </div>

    <div class="card">
      <label>Куда отправлять (выберите водоёмы)</label>
      <div class="groups" id="groupList">
        <!-- Чекбоксы тем: названия + ссылки (ID темы извлекается из ссылки автоматически) -->
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/4"  /> Лосиное</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/3"  /> Комариное</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/5"  /> Вьюнок</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/7"  /> Белая</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/6"  /> Острог</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/8"  /> Куори</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/9"  /> Медвежье</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/10" /> Волхов</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/11" /> Донец</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/12" /> Сура</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/13" /> Ладожское</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/15" /> Архипелаг</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/14" /> Янтарное</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/16" /> Ахтуба</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/17" /> Медное</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/18" /> Тунгуска</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/19" /> Яма</label>
        <label><input type="checkbox" class="group" value="https://t.me/PP4Farm/20" /> Норвежское море</label>
      </div>
    </div>

    <div class="card">
      <button class="btn" id="sendBtn">Отправить</button>
      <button class="btn" id="clearBtn" style="background:#263553">Очистить</button>
    </div>

    <div class="card">
      <div class="log" id="log"></div>
    </div>
  </div>

<script>
const WORKER_BASE = "https://rf-proxy.atvclub.workers.dev";
const GROUP_USERNAME = "PP4Farm"; // одна супер-группа с темами
const MAX_PHOTOS = 10;
const MAX_PIXELS = 2000; // длинная сторона
const JPEG_QUALITY = 0.85;

let GROUP_CHAT_ID = ""; // подтянем автоматически по username

const elText   = document.getElementById('text');
const elFiles  = document.getElementById('files');
const elThumbs = document.getElementById('thumbs');
const elCount  = document.getElementById('count');
const elSend   = document.getElementById('sendBtn');
const elClear  = document.getElementById('clearBtn');
const elLog    = document.getElementById('log');

function log(line) {
  elLog.textContent += `[${new Date().toLocaleTimeString()}] ${line}\n`;
  elLog.scrollTop = elLog.scrollHeight;
}
function alertT(msg){ if(window.Telegram?.WebApp){ Telegram.WebApp.showAlert(msg); } else { alert(msg); } }

function getSelectedTopicIds(){
  const links = [...document.querySelectorAll('.group:checked')].map(x => x.value);
  const ids = links.map(l => {
    const seg = (l.trim().split('/').pop()||'').replace(/\D+/g,'');
    const n = parseInt(seg,10);
    return Number.isFinite(n) ? n : null;
  }).filter(v => v !== null);
  return ids;
}

// Preview
elFiles.addEventListener('change', () => {
  elThumbs.innerHTML = '';
  const files = [...elFiles.files].slice(0, MAX_PHOTOS);
  files.forEach(f => {
    const img = document.createElement('img');
    img.src = URL.createObjectURL(f);
    img.alt = f.name;
    elThumbs.appendChild(img);
  });
  elCount.textContent = `${files.length} / ${MAX_PHOTOS}`;
  if (elFiles.files.length > MAX_PHOTOS) {
    log('Выбрано больше 10 файлов — лишние будут проигнорированы.');
  }
});

// JPEG + ресайз (устраняет проблемы HEIC/больших фото)
async function reencodeToJpeg(file){
  if (file.size > 40 * 1024 * 1024) {
    throw new Error(`Файл ${file.name} слишком большой: ${(file.size/1024/1024).toFixed(1)}MB. Уменьшите его.`);
  }
  const url = URL.createObjectURL(file);
  let bmp;
  try {
    bmp = await createImageBitmap(await fetch(url).then(r=>r.blob()));
  } catch {
    throw new Error(`Не удалось прочитать ${file.name}. Если это HEIC/Live Photo — экспортируйте в JPEG/PNG.`);
  } finally {
    URL.revokeObjectURL(url);
  }
  const canvas = document.createElement('canvas');
  let { width, height } = bmp;
  const scale = Math.max(width, height) > MAX_PIXELS ? MAX_PIXELS / Math.max(width, height) : 1;
  width = Math.round(width * scale); height = Math.round(height * scale);
  canvas.width = width; canvas.height = height;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(bmp, 0, 0, width, height);
  const dataUrl = canvas.toDataURL('image/jpeg', JPEG_QUALITY);
  return dataUrl.split(',')[1]; // чистый base64
}

async function uploadToImgbb(base64, name){
  const r = await fetch(`${WORKER_BASE}/upload`, {
    method: 'POST',
    headers: { 'content-type':'application/json' },
    body: JSON.stringify({ imageBase64: base64, name })
  });
  const j = await r.json();
  if (!j.ok) {
    const reason = (j.error && typeof j.error === 'string') ? j.error : JSON.stringify(j.error||j);
    throw new Error(`imgbb: ${reason} (status ${j.status||'?'})`);
  }
  return j.url;
}

async function sendToTelegram(chat_id, text, mediaUrls, message_thread_id){
  const r = await fetch(`${WORKER_BASE}/send`, {
    method:'POST',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ chat_id, text, media: mediaUrls, message_thread_id })
  });
  const j = await r.json();
  if (!j.ok) throw new Error('telegram: '+JSON.stringify(j.error||j));
  return j.result;
}

async function resolveChatId(username){
  const r = await fetch(`${WORKER_BASE}/get_chat_id?username=${encodeURIComponent(username)}`);
  const j = await r.json();
  if (!j.ok) throw new Error('resolve chat_id: '+JSON.stringify(j.error||j));
  return j.chat_id;
}

// Автоматически подтягиваем chat_id, не меняя UI
(async function init() {
  try {
    if (window.Telegram?.WebApp) { Telegram.WebApp.expand(); Telegram.WebApp.ready(); }
    log(`Определяю chat_id для @${GROUP_USERNAME}…`);
    GROUP_CHAT_ID = String(await resolveChatId(GROUP_USERNAME));
    log(`✓ chat_id: ${GROUP_CHAT_ID}`);
  } catch (e) {
    log('Не удалось определить chat_id автоматически. Убедись, что бот в группе и @username верный.');
  }
})();

elSend.addEventListener('click', async () => {
  try {
    elSend.disabled = true;

    if (!GROUP_CHAT_ID) { alertT('Не удалось определить chat_id группы. Проверь, что бот добавлен в @PP4Farm.'); return; }

    const files = [...elFiles.files].slice(0, MAX_PHOTOS);
    const text  = elText.value.trim();
    const topics = getSelectedTopicIds();

    if (!text && files.length === 0) { alertT('Добавьте текст или фото.'); return; }
    if (topics.length === 0) { alertT('Выберите хотя бы один водоём (тему).'); return; }

    log(`Старт: файлов ${files.length}, тем ${topics.length}`);

    const urls = [];
    for (let i=0;i<files.length;i++){
      const f = files[i];
      try {
        log(`Подготовка ${i+1}/${files.length}: ${f.name}`);
        const b64 = await reencodeToJpeg(f);

        // Ретраи на imgbb
        let url, attempt=0, lastErr=null;
        while(attempt<3){
          try { url = await uploadToImgbb(b64, f.name.replace(/\.[^.]+$/,'')); break; }
          catch(err){ lastErr=err; attempt++; log(`imgbb retry ${attempt}/3: ${err.message||err}`); await new Promise(r=>setTimeout(r, 800*attempt)); }
        }
        if(!url) throw lastErr || new Error('Не удалось загрузить на imgbb.');
        urls.push(url);
        log(`✓ URL: ${url}`);
      } catch(e) {
        log(`ОШИБКА файла ${f.name}: ${e?.message||e}`);
        alertT(`Не удалось обработать/загрузить "${f.name}": ${e?.message||e}`);
        return;
      }
    }

    for (const tid of topics) {
      log(`Отправка в тему #${tid}…`);
      await sendToTelegram(GROUP_CHAT_ID, text, urls, tid);
      log(`✓ Отправлено в тему #${tid}`);
    }

    alertT('Публикация отправлена!');
    log('Готово ✔');
  } catch (e) {
    console.error(e);
    log('ОШИБКА: ' + (e?.message || e));
    alertT('Ошибка: ' + (e?.message || e));
  } finally {
    elSend.disabled = false;
  }
});

elClear.addEventListener('click', () => {
  elText.value = "";
  elFiles.value = "";
  elThumbs.innerHTML = "";
  elCount.textContent = `0 / ${MAX_PHOTOS}`;
  elLog.textContent = "";
  [...document.querySelectorAll('.group')].forEach(cb => { cb.checked = false; });
});
</script>
</body>
</html>
