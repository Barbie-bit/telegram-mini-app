<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Мини-приложение для рыбалки</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-image: url('/mnt/data/A_promotional_digital_illustration_for_"Russian_Fi.png');
      background-size: cover; background-position: center;
      color:#333; padding:20px; height:100vh; margin:0;
    }
    .container { background:rgba(255,255,255,.8); border-radius:10px; padding:20px; max-width:600px; margin:0 auto; }
    .button,.photo-button { color:#fff; padding:15px 32px; font-size:16px; margin:4px 2px; cursor:pointer; border-radius:4px; width:100%; text-align:center; display:inline-block; text-decoration:none; }
    .button{ background:#4CAF50; } .photo-button{ background:#007bff; padding:10px 20px; }
    input,select{ margin:10px 0; padding:8px; width:100%; max-width:300px; }
    label{ font-size:16px; margin-bottom:5px; display:block; }
    #photoCountInfo{ margin-top:10px; font-size:14px; color:#666; }
    /* инпут файла должен быть «невидим», но НЕ display:none */
    .file-input-ghost{ position:absolute; left:-9999px; width:1px; height:1px; opacity:0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Рыбалка на сегодня!</h1>

    <label for="category">Выберите категорию:</label>
    <select id="category">
      <option value="Фарм">Фарм</option>
      <option value="Трофей">Трофей</option>
      <option value="Уникальное">Уникальное</option>
    </select>

    <label for="lake">Выберите водоём:</label>
    <select id="lake" onchange="updateFishList()">
      <option>Лосиное</option><option>Комариное</option><option>Вьюнок</option><option>Белая</option>
      <option>Острог</option><option>Куори</option><option>Медвежье</option><option>Волхов</option>
      <option>Донец</option><option>Сура</option><option>Ладожское</option><option>Архипелаг</option>
      <option>Янтарное</option><option>Ахтуба</option><option>Медное</option><option>Тунгуска</option>
      <option>Яма</option><option>Норвежское море</option>
    </select>

    <label for="fish">Выберите рыбу:</label>
    <select id="fish"></select>

    <label for="coordinates">Координаты:</label>
    <input id="coordinates" type="text" placeholder="например, 50.1234:30.5678" />

    <label for="depth">Глубина:</label>
    <input id="depth" type="text" placeholder="например, 3.2" />

    <label for="clips">Клипса:</label>
    <input id="clips" type="text" placeholder="например, 25" />

    <label for="speed">Скорость:</label>
    <input id="speed" type="text" placeholder="например, 35" />

    <label for="square">Квадрат:</label>
    <input id="square" type="text" placeholder="например, D6" />

    <label for="comment">Комментарий:</label>
    <input id="comment" type="text" placeholder="доп. информация" />

    <button class="button" onclick="sendData()">Опубликовать</button>

    <!-- заменили кнопку на label, чтобы ПК десктоп не блокировал выбор файлов -->
    <label class="photo-button" for="fileInput">Добавить фото (мин. 3, макс. 10)</label>
    <input id="fileInput" type="file" accept="image/*" multiple class="file-input-ghost" />

    <div id="photoCountInfo">Выбрано 0 фото. Минимум 3, максимум 10.</div>
  </div>

<script>
  // ===== настройки =====
  const WORKER_BASE = "https://rf-proxy.atvclub.workers.dev";
  const MAX_PHOTOS = 10;

  // chat_id твоей группы
  const CHAT_ID = -1002823326154;

  // темы (topic_id) по водоёмам
  const THREAD_BY_LAKE = {
    "Лосиное":4,"Комариное":3,"Вьюнок":5,"Белая":7,"Острог":6,"Куори":8,"Медвежье":9,"Волхов":10,
    "Донец":11,"Сура":12,"Ладожское":13,"Архипелаг":15,"Янтарное":14,"Ахтуба":16,"Медное":17,
    "Тунгуска":18,"Яма":19,"Норвежское море":20
  };

  // кастом-эмодзи из твоего набора
  const CUSTOM_EMOJI_IDS = {
    TROPHY: "5341269699227321203",
    UNIQUE: "5341321204475133248",
  };

  // ===== рыбы по водоёмам (полный список из твоего сообщения) =====
  const fishByWater = {
    "Лосиное":["Вармоус","Горбыль речной","Доросома северная","Краппи белый","Краппи чёрный","Лаврак полосатый","Лаврак полосатый гибрид","Окунь белый","Окунь большеротый","Окунь малоротый","Окунь павлиний","Окунь пятнистый","Панцирник пятнистый","Солнечник красноухий","Солнечник синежаберный","Сомик канальный","Сомик оливковый","Судак светлопёрый","Щука панцирная"],
    "Комариное":["Вьюн","Голавль","Густера","Ёрш","Карась золотой","Карась серебряный","Карп зеркальный","Карп Кои Мидори-гои","Карп чешуйчатый","Лещ","Линь","Линь золотистый","Лягушка","Окунь","Плотва обыкновенная","Ротан","Сом","Уклейка","Щука обыкновенная","Язь"],
    "Вьюнок":["Разнорыбица","Белоглазка","Берш","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Ёрш-носарь","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Лещ","Линь","Лягушка","Налим","Окунь","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Ротан","Синец","Сом","Судак","Уклейка","Щука обыкновенная","Язь"],
    "Белая":["Разнорыбица","Белоглазка","Голавль","Густера","Елец","Ёрш","Жерех","Карась золотой","Карась серебрянный","Карп чешуйчатый","Лещ","Лягушка","Налим","Окунь","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Сиг-пыжьян","Сом","Стерлядь","Судак","Таймень","Уклейка","Форель ручьевая","Хариус европейский","Хариус западносибирский","Щука обыкновенная","Язь"],
    "Острог":["Разнорыбица","Амур белый","Амур чёрный","Голавль","Густера","Ёрш","Карась золотой","Карась серебряный","Карп чешуйчатый","Лещ","Линь","Лягушка","Налим","Окунь","Плотва обыкновенная","Ротан","Сиг острожский","Сом","Угорь","Уклейка","Щука обыкновенная","Язь"],
    "Куори":["Разнорыбица","Голец арктический","Голец Куорский","Гольян","Густера","Ёрш","Карась золотой","Карась серебряный","Карп чешуйчатый","Лещ","Лягушка","Налим","Окунь","Палия обыкновенная","Пелядь","Плотва обыкновенная","Ряпушка","Сиг куорский","Форель озёрная","Форель радужная","Форель ручьевая","Форель севанская","Хариус европейский","Щука обыкновенная","Язь"],
    "Медвежье":["Разнорыбица","Амур белый","Амур белый альбинос","Амур чёрный","Голавль","Густера","Ёрш","Карась золотой","Карась серебряный","Карп голый","Карп зеркальный","Карп чешуйчатый","Лещ","Линь","Линь золотистый","Лягушка","Налим","Окунь","Перловица","Плотва обыкновенная","Ротан","Уклейка","Усач альбинос","Усач обыкновенный","Щука обыкновенная","Язь"],
    "Волхов":["Разнорыбица","Белоглазка","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Лещ","Линь","Лосось атлантический","лосось ладожский","Лягушка","Налим","Окунь","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Ротан","Рыбец","Ряпушка","Синец","Сом","Судак","Угорь","Уклейка","Щука обыкновенная","Язь"],
    "Донец":["Разнорыбица","Амур белый","Белоглазка","Белуга черноморская","Берш","Вырезуб","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Ёрш-носарь","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Краснопёрка","Лещ","Линь","Лягушка","Минога Украинская","Налим","Окунь","Окунь солнечный","Осётр Русский","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Сазан","Сельдь черноморская","Уклейка","Чехонь","Шемая черноморская","Щука обыкновенная","Язь"],
    "Сура":["Разнорыбица","Белоглазка","Берш","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Краснопёрка","Лещ","Линь","Лягушка","Налим","Окунь","Осётр Русский","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Рак речной","Ротан","Рыбец","Сазан","Синец","Сом","Стерлядь","Судак","Толстолобик белый","толстолобик пёстрый","Угорь","Уклейка","Чехонь","Щука обыкновенная","Язь"],
    "Ладожское":["Разнорыбица","Белоглазка","Голавль","Гольян","Густера","Елец","Ёрш","Карась золотой","Карась серебряный","Карп чешуйчатый","Колюшка трёхиглая","Корюшка","Лещ","Лосось атлантический","Лосось ладожский","Лягушка","Налим","Окунь","Осётр балтийский","Палия обыкновенная","Плотва обыкновенная","Рипус","Рыбец","Ряпушка","Сиг Валаамский","Сиг Волховский","Сиг Вуоксинский","Сиг-Лудога","Синец","Сом","Судак","Угорь","Уклейка","Форель озёрная","Хариус европейский","Щука обыкновенная","Язь"],
    "Архипелаг":["Разнорыбица","Белоглазка","Голавль","Гольян","Густера","Елец","Ёрш","Карась золотой","Карась серебряный","Карп чешуйчатый","Колюшка трёхиглая","Корюшка","Лещ","Лосось атлантический","Лосось ладожский","Налим","Окунь","омуль Байкальский","Осётр Балтийский","Осётр Ладожский","Палия кряжевая","Палия лудожная","Палия обыкновенная","Рыбец","Ряпушка","Сиг Валаамский","Сиг Волховский","Сиг Вуоксинский","Сиг Ладожский озёрный","Сиг Свирский","Сиг чёрный","Сиг-Лудога","Синец","Сом","Судак","Угорь","Уклейка","Форель озёрная","Хариус европейский","Щука обыкновенная","Язь"],
    "Янтарное":["Разнорыбица","Амур белый","Голавль","Густера","Ёрш","Карась золотой","Карась серебряный","Карп голый","Карп голый - альбинос","Карп голый - призрак","Карп зеркальный","Карп зеркальный - альбинос","Карп зеркальный - призрак","Карп красный Старвас - зеркальный","Карп красный Старвас - чешуйчатый","Карп линейный","Карп линейный - альбинос","Карп линейный - призрак","Карп рамчатый","Карп рамчатый - альбинос","Карп рамчатый - призрак","Карп чешуйчатый","Карп чешуйчатый - альбинос","Карп чешуйчатый - призрак","Лещ","Линь","Лягушка","Налим","Окунь","Плотва обыкновенная","Ротан","Сом","Угорь","Уклейка","Усач обыкновенный","Щука обыкновенная","Язь"],
    "Ахтуба":["Разнорыбица","Амур белый","Белоглазка","Белорыбица","Белуга каспийская","Буффало большеротый","Буффало чёрный","Вобла","Вьюн","Голавль","Густера","Дрейссена речная","Елец","Ёрш","Жерех","Карась золотой","Карась серебряный","Карп чешуйчатый","Колюшка малая южная","Краснопёрка","Кутум","Лещ","Лещ восточный","Линь","Лосось каспийский","Лягушка","Минога каспийская","Налим","Окунь","Осётр Персидский","Осётр Русский","Перловица","Пескарь обыкновенный","Плотва обыкновенная","Подуст","Пузанок каспийский","Рак речной","Сазан","Севрюга","Сельдь Бражникова","Сельдь Кесслера","Синец","Сом","Сом альбинос","Стерлядь","Судак","Толстолобик белый","Толстолобик пёстрый","Уклейка","Усач короткоголовый","Чехонь","Шемая каспийская","Шип","Щука обыкновенная","Язь"],
    "Медное":["Разнорыбица","Голавль","Густера","Ёрш","Карасекарп","Карась золотой","Карась серебряный","Карп голый","Карп Динкенбюльский голый","Карп Динкенбюльский зеркальный","Карп Динкенбюльский линейный","Карп зеркальный","Карп Кои Ёцусиро","Карп Кои Кохаку","Карп Кои Мамэсибори Госики","Карп Кои Хи Уцури","Карп Супер Фрикс","Карп чешуйчатый","Лещ","Линь","Линь Квольсдорфский","Лягушка","Окунь","Плотва обыкновенная","ротан","Уклейка","Усач обыкновенный","Щука обыкновенная","Язь"],
    "Тунгуска":["Разнорыбица","Валёк","Голец арктический","Голец Дерягина","Голец сибирский-усач","Гольян озёрный","Горбуша","Елец сибирский","Ёрш","Карась золотой","Карась серебряный","Колюшка трёхиглая","Корюшка азиатская","Ленок остроносый","Лещ восточный","Линь","Лягушка","Минога сибирская","Муксун","Налим","Нельма","Окунь","Омуль арктический","омуль Байкальский","Осётр восточносибирский","Пелядь","Перловица","пескарь сибирский","Плотва сибирская","Подкаменщик сибирский","Ряпушка сибирская","Сиг-пыжьян","Сом амурский","Стерлядь сибирская","Таймень","Тугун","Форель ручьевая","Хариус восточносибирский","Хариус западносибирский","Чир","Щука обыкновенная","Язь"],
    "Яма":["Разнорыбица","Валёк","Голец арктический","Голец Леванидова","Голец сибирский-усач","Горбуша","Калуга","Кета","Кижуч","Колюшка девятииглая","Корюшка азиатская","Краснопёр Монгольский","Краснопёр-Угай крупночешуйчатый","Кунджа","Ленок острорылый","Ленок тупорылый","Мальма","Микижа","Минога дальневосточная","Минога трёхзубая","Налим","Нейва","Нерка","Окунь","Сима","Сима жилая","Хариус восточносибирский","Чавыча","Чукучан"],
    "Норвежское море":["Разнорыбица","Акула гигантская","Акула гренладская полярная","Акула плащеносная","Акула сельдевая","Бельдюга европейская","Берикс красный","Гимантолоф атлантический","Горбыль серебристый","Гребешок исландский","Зубатка полостатая","Зубатка пятнистая","Зубатка синяя","Кальмар обыкновенный","Камбала морская","Камбала палтусовидная","Камбала хоботная","Катран","Керчак европейский","Конгер","Краб камчатский","Краб съедобный","Ликод полуолый","Ликод Эсмарка","Макрель атлантическая","Макрурус северный","Менёк","Мерланг","Мерлуза","Меч-рыба","Мидия","Мольва голубая","Мольва обыкновенная","Морской чёрт","Окунь каменный","Окунь морской золотстый","Окунь морской норвежский","Окунь-клювач","Опах краснопёрый","палтус атлантический","Палтус синекорый","пикша","Пинагор","Поллак","Путассу северная","Сайда","Сайра атлантическая","Сардина европейская","Сельдь атлантическая","Скат колючий","Скат полярный","Треска атлантическая","Тунец голубой","Тюрбо","Угольщик обыкновенный","Устрица съедобная","Химера европейская","Центролоф чёрный"]
  };

  function updateFishList(){
    const lake = document.getElementById('lake').value;
    const fishList = fishByWater[lake] || [];
    const sel = document.getElementById('fish');
    sel.innerHTML = '';
    if (fishList.length === 0){
      const o=document.createElement('option'); o.value=''; o.textContent='Не выбрано'; sel.appendChild(o);
    } else {
      fishList.forEach(f=>{ const o=document.createElement('option'); o.value=f; o.textContent=f; sel.appendChild(o); });
    }
  }
  updateFishList();

  // ===== фото =====
  let selectedPhotos = [];
  function updatePhotoCount(){ document.getElementById('photoCountInfo').textContent = `Выбрано ${selectedPhotos.length} фото. Минимум 3, максимум 10.`; }
  updatePhotoCount();

  async function blobToBase64(blob){ const buf=await blob.arrayBuffer(); return btoa(String.fromCharCode(...new Uint8Array(buf))); }

  async function uploadToImgbbViaWorker(fileBlob,name){
    // 1) multipart
    const form=new FormData(); form.set('file',fileBlob,(name||'photo')+'.jpg');
    try{
      const r=await fetch(`${WORKER_BASE}/upload`,{method:'POST',body:form,mode:'cors'});
      const j=await r.json(); if(j?.ok && j.url) return j.url; throw new Error('multipart fail');
    }catch{
      // 2) base64
      const b64=await blobToBase64(fileBlob);
      const r2=await fetch(`${WORKER_BASE}/upload`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({imageBase64:b64,name:name||'photo'}),mode:'cors'});
      const j2=await r2.json(); if(j2?.ok && j2.url) return j2.url; throw new Error('json fallback fail');
    }
  }

  // слушаем НЕ скрытый display:none, а «призрачный» инпут, на который кликает label
  document.getElementById('fileInput').addEventListener('change', async (e)=>{
    const files=[...e.target.files||[]]; if(!files.length) return;
    const slice=files.slice(0, Math.min(MAX_PHOTOS-selectedPhotos.length, files.length));
    for(const file of slice){
      try{ const url=await uploadToImgbbViaWorker(file, file.name.replace(/\.[^.]+$/,'')); selectedPhotos.push({imageUrl:url}); }
      catch{ alert(`Не удалось загрузить файл: ${file.name}`); }
    }
    updatePhotoCount(); e.target.value="";
  });

  // ===== текст + кастом-эмодзи =====
  function buildTextAndEntities(){
    const category=document.getElementById('category').value;
    const lake=document.getElementById('lake').value;
    const fish=(document.getElementById('fish').value||"").trim();

    const coordinates=document.getElementById('coordinates').value.trim();
    const depth=document.getElementById('depth').value.trim();
    const clips=document.getElementById('clips').value.trim();
    const speed=document.getElementById('speed').value.trim();
    const square=document.getElementById('square').value.trim();
    const comment=document.getElementById('comment').value.trim();

    // две строки-хэштегов + пустая строка (как на скрине)
    const head=[`# ${category.toLowerCase()}_PP4Farm`, `# ${lake}_PP4Farm`, ''];

    // строка с рыбой + наш кастом-эмодзи
    let fishLine = "";
    let emojiChar = "";           // базовый символ, на который "натянем" кастом-эмодзи
    let customId  = null;

    if (fish){
      if (category === 'Трофей') { emojiChar = '💥'; customId = "5341269699227321203"; }
      if (category === 'Уникальное') { emojiChar = '🌸'; customId = "5341321204475133248"; }
      fishLine = `🐟 ${fish}${customId ? ' ' + emojiChar : ''}`;
    }

    const details=[];
    if (coordinates) details.push(`📍 Координаты: ${coordinates}`);
    if (clips)       details.push(`🎣 Клипса: ${clips}`);
    if (depth)       details.push(`🎣 Глубина: ${depth}`);
    if (speed)       details.push(`⋙ Скорость: ${speed}`);
    if (square)      details.push(`🗺 Квадрат: ${square}`);
    if (comment)     details.push(`💬 Комментарий: ${comment}`);

    const parts=[...head];
    if (fishLine) parts.push(fishLine);
    if (details.length) parts.push(...details);

    let text = parts.join('\n').replace(/\n{3,}/g,'\n\n').trim();

    // помечаем именно наш emojiChar как custom_emoji
    const entities=[];
    if (customId){
      const idx = text.lastIndexOf(emojiChar); // он один в строке рыбы
      if (idx >= 0){
        entities.push({ type:'custom_emoji', offset: idx, length: emojiChar.length, custom_emoji_id: customId });
      }
    }
    return { text, entities: entities.length ? entities : undefined };
  }

  // ===== отправка =====
  async function sendData(){
    if (selectedPhotos.length < 3){ alert("Необходимо выбрать минимум 3 фото."); return; }

    const { text, entities } = buildTextAndEntities();
    const lake = document.getElementById('lake').value;
    const message_thread_id = THREAD_BY_LAKE[lake] ?? null;

    const payload = {
      chat_id: CHAT_ID,
      text,
      media: selectedPhotos.map(p=>p.imageUrl),
      entities,
      message_thread_id
    };

    try{
      const r=await fetch(`${WORKER_BASE}/send`,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(payload)});
      const j=await r.json();
      if(!j?.ok){ console.log('Ошибка публикации:', j); alert("Ошибка публикации"); return; }
      alert("Опубликовано!");
      // сброс формы
      document.querySelectorAll('input').forEach(el=>el.value="");
      selectedPhotos=[]; updatePhotoCount();
    }catch(e){ console.error(e); alert("Сеть недоступна или ошибка сервера"); }
  }
</script>
</body>
</html>
